<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>果實分配</title>
    <!-- 載入 Noto Sans TC 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- 連結樣式表 -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- 標頭區 -->
    <header>
        <h1 id="mainTitle">果實分配</h1>
        
        <!-- [新增] 雲端狀態指示器 -->
        <div id="cloudStatus" class="cloud-status" style="display: none;">
            <span class="status-dot"></span>
            <span id="cloudStatusText">連線中...</span>
        </div>

        <div class="header-controls">
            <!-- [新增] 存檔切換選單 -->
            <select id="saveSlotSelect" class="save-slot-select">
                <option value="default">📁 存檔 1 (預設)</option>
                <option value="slot2">📁 存檔 2</option>
                <option value="slot3">📁 存檔 3</option>
                <option value="slot4">📁 存檔 4</option>
                <option value="slot5">📁 存檔 5</option>
            </select>

            <input type="text" id="recordName" placeholder="輸入紀錄名稱">
            <!-- 儲存按鈕現在會觸發雲端同步，或手動下載備份 -->
            <button id="saveData" class="btn btn-green">💾 下載備份</button>
            <input type="file" id="loadFile" style="display:none;" accept=".json">
            <button id="loadData" class="btn btn-blue">📂 載入備份</button>
            <button id="resetAllData" class="btn btn-red">🔥 全部初始化</button>
        </div>
    </header>

    <!-- 角色管理 -->
    <section class="section-card">
        <h2>角色管理 (主力需求方)</h2>
        <div class="control-row">
            <input type="text" id="newCharacter" placeholder="輸入主力角色名稱" class="input-wide">
            <button id="addCharacter" class="btn btn-green">➕ 新增角色</button>
            <button id="showCharacterList" class="btn btn-blue">📋 角色清單 (<span id="characterCount">0</span>)</button>
            <button id="resetCharacterList" class="btn btn-red">🔄 重置角色清單</button>
        </div>
    </section>

    <!-- 果實庫存管理 (新增分頁) -->
    <section class="section-card">
        <h2>果實庫存管理</h2>
        
        <!-- 分頁按鈕 -->
        <div class="tabs-header">
            <button class="tab-btn active" data-tab="tab-overview">📊 總覽</button>
            <button class="tab-btn" data-tab="tab-bank">🐦 英雄 BANK (鳥籠)</button>
            <button class="tab-btn" data-tab="tab-storage">📦 角色暫存箱 (<span id="storageCharCount">0</span> 隻)</button>
        </div>

        <!-- 分頁 1: 總覽 (只讀卡片顯示) -->
        <div id="tab-overview" class="tab-content active">
             <!-- 卡片結構，只用於顯示總覽資訊 -->
            <div class="inventory-container">
                <!-- 左側：加擊類總覽 -->
                <div class="inventory-box box-green">
                    <div class="box-title title-green">⚔️ 加擊類總覽</div>
                    <div id="attackFruitsOverview" class="fruit-grid col-3"></div>
                </div>

                <!-- 右側：其他類總覽 -->
                <div class="inventory-box box-blue">
                    <div class="box-title title-blue">🎯 其他類總覽</div>
                    <div id="otherFruitsOverview" class="fruit-grid col-2"></div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 15px; color: #666; font-size: 13px;">
                ※ 總庫存 = 英雄 BANK + 角色暫存箱。
            </div>
            <div class="add-fruit-row">
                <strong>新增果實類型：</strong>
                <input type="text" id="newFruitName" placeholder="果實名稱">
                <select id="newFruitCategory">
                    <option value="加擊類">加擊類</option>
                    <option value="其他">其他</option>
                </select>
                <button id="addFruit" class="btn btn-green">➕ 新增果實</button>
                <button id="deleteFruitBtn" class="btn btn-red">🗑️ 刪除果實</button>
            </div>
        </div>

        <!-- 分頁 2: 英雄 BANK (下拉選單 + 轉移按鈕) -->
        <div id="tab-bank" class="tab-content">
            <h3 style="text-align: center; margin-bottom: 15px;">鳥籠數量：7 個</h3>
            <div class="bank-container">
                <!-- BANK 果實選擇將在這裡渲染 -->
                <div id="bankFruitSelectors" class="fruit-grid col-3">
                    <!-- JS 會在這裡填充 7 個鳥籠的下拉選單 -->
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="resetBank" class="btn btn-red">🔄 重置所有鳥籠</button>
            </div>
        </div>

        <!-- 分頁 3: 角色暫存箱 (新增轉移按鈕) -->
        <div id="tab-storage" class="tab-content">
            <div class="control-row" style="margin-bottom: 20px;">
                <input type="text" id="newStorageChar" placeholder="輸入倉庫角色名稱 (例: 4星角)" class="input-wide">
                <button id="addStorageChar" class="btn btn-green">➕ 新增倉庫角色</button>
                <input type="text" id="searchStorageChar" placeholder="🔍 搜尋倉庫..." style="margin-left: 10px;">
            </div>
            
            <div class="table-container">
                <table id="storageTable">
                    <thead>
                        <tr>
                            <th>倉庫角色</th>
                            <th>持有果實 1</th>
                            <th>持有果實 2</th>
                            <th>持有果實 3</th>
                            <th>持有果實 4</th>
                            <th style="width: 140px;">操作</th> <!-- 擴大操作欄位 -->
                        </tr>
                    </thead>
                    <tbody id="storageTableBody"></tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 15px; color: #666; font-size: 13px;">
                ※ 這裡的角色僅用於「暫存果實」，其持有的果實會自動計入總庫存量。
            </div>
        </div>

    </section>

    <!-- 果實分配 -->
    <section class="section-card">
        <h2>果實分配 (主力區) (<span id="uncompletedCharCount">0</span> 待辦)</h2>
        <div style="text-align: center; margin-bottom: 15px;">
             <button id="resetAssignments" class="btn btn-red">🔄 重置角色果實</button>
        </div>

        <div class="search-row">
            <!-- 搜尋欄 -->
            <input type="text" id="searchCharacter" placeholder="🔍 搜尋角色名稱或果實..." class="input-wide">
            
            <!-- 排序選單 -->
            <select id="sortCharacterBy" class="sort-select">
                <option value="default">預設排序 (添加時間)</option>
                <option value="unassigned_asc">未完成分配數量 (少到多)</option>
                <option value="unassigned_desc">未完成分配數量 (多到少)</option>
            </select>
            
            <div class="checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="filterModeCheckbox">
                    <span>僅顯示搜尋結果</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="hideCompletedCheckbox">
                    <span>隱藏已完成分配</span>
                </label>
            </div>
        </div>

        <div class="preset-section">
            <h3>快速分配組合</h3>
            <div class="preset-controls">
                <select id="presetCharacter">
                    <option value="">選擇角色</option>
                </select>
                <button id="presetBtn1" class="btn btn-green">同族組合</button>
                <button id="presetBtn2" class="btn btn-blue">戰型組合</button>
                <button id="presetBtn3" class="btn btn-indigo">擊種組合</button>
                <button id="presetBtn4" class="btn btn-teal">速必雙削</button>
                <button id="resetPresetCharacter" class="btn btn-red">🔄 重置</button>
            </div>
        </div>

        <!-- 滾動容器 -->
        <div class="table-scroll-container">
            <table id="fruitTable">
                <thead>
                    <tr>
                        <th>角色</th>
                        <th>果實 1</th>
                        <th>果實 2</th>
                        <th>果實 3</th>
                        <th>果實 4</th>
                    </tr>
                </thead>
                <tbody id="fruitTableBody"></tbody>
            </table>
        </div>
    </section>

    <!-- 懸浮工具箱 -->
    <div class="toolbox-container">
        <div class="toolbox-header">
            🧰 工具箱
        </div>
        <div class="toolbox-list">
            <a href="https://emily4027.github.io/monster-strike-toolbox/" class="toolbox-link">
                🏠 工具箱首頁
            </a>
            <a href="https://emily4027.github.io/monster-strike-gacha/" class="toolbox-link">
                🎰 抽卡模擬
            </a>
            <div class="toolbox-link active">
                🍎 果實分配
            </div>
        </div>
    </div>

    <!-- 彈出視窗 (Modals) -->
    
    <!-- 1. 角色清單 Modal -->
    <div id="characterModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>角色清單</h3>
                <span class="close-modal">&times;</span>
            </div>
            <input type="text" id="modalCharacterSearch" placeholder="🔍 搜尋要刪除的角色..." class="full-width-input">
            <ul id="characterList"></ul>
        </div>
    </div>

    <!-- 2. 刪除果實 Modal -->
    <div id="deleteFruitModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>刪除果實</h3>
                <span class="close-modal">&times;</span>
            </div>
            <p>選擇要刪除的果實：</p>
            <select id="deleteFruitSelect" class="full-width-input">
                <option value="">請選擇果實</option>
            </select>
            <div class="modal-footer">
                <button class="close-btn-action btn-gray">取消</button>
                <button id="confirmDeleteFruit" class="btn btn-red">確認刪除</button>
            </div>
        </div>
    </div>

    <!-- 3. 果實轉移 Modal (New! 支援多目的地) -->
    <div id="fruitTransferModal" class="modal">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>果實轉移</h3>
                <span class="close-modal transfer-close">&times;</span>
            </div>
            <p id="transferSourceMessage" style="font-weight: bold;"></p>
            
            <!-- 倉庫果實來源選擇區 -->
            <div id="storageSourceSelector" style="margin-bottom: 15px; display: none;">
                 <p style="margin-top: 15px; font-weight: bold;">選擇移出果實欄位:</p>
                 <select id="storageSourceSlotSelect" class="full-width-input"></select>
            </div>
            
            <hr style="margin: 15px 0;">

            <p style="margin-top: 15px; font-weight: bold;">選擇轉移目標：</p>
            
            <!-- 新增目的地選擇 -->
            <select id="transferDestinationType" class="full-width-input" style="margin-bottom: 10px;">
                <option value="">-- 請選擇目標類型 --</option>
                <option value="main">主力角色 (填補空缺)</option>
                <option value="bank">英雄 BANK (空閒鳥籠)</option>
                <option value="storage">倉庫角色 (空閒果實欄位)</option>
            </select>
            
            <!-- 目標角色/鳥籠/欄位選擇容器 -->
            <div id="transferTargetContainer">
                <p style="margin-top: 15px;">目標容器:</p>
                <select id="transferTargetSelect" class="full-width-input"></select>
                
                <p style="margin-top: 15px;">目標欄位/位置:</p>
                <select id="transferSlotSelect" class="full-width-input"></select>
            </div>

            
            <div class="modal-footer">
                <button class="transfer-close btn btn-gray">取消</button>
                <button id="confirmTransferBtn" class="btn btn-green">確認轉移</button>
            </div>
        </div>
    </div>

    <!-- 4. 警告/提示 Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content small-modal">
            <h3 id="alertTitle">提示</h3>
            <p id="alertMessage"></p>
            <div class="modal-footer">
                <button id="alertOkBtn" class="btn btn-blue">確認</button>
            </div>
        </div>
    </div>

    <!-- 5. 確認 Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content small-modal">
            <h3 id="confirmTitle">請確認</h3>
            <p id="confirmMessage"></p>
            <div class="modal-footer">
                <button id="confirmCancelBtn" class="btn btn-gray">取消</button>
                <button id="confirmOkBtn" class="btn btn-red">確認</button>
            </div>
        </div>
    </div>

    <!-- 🎯 引入 Firebase SDK (與 Toolbox.html 保持一致) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ⚠️ 您的 Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyAjpfcNC4ZniqIxYzgYwp5Cs_8gbbmflVY",
            authDomain: "ms-toolbox-web.firebaseapp.com",
            projectId: "ms-toolbox-web",
            storageBucket: "ms-toolbox-web.firebasestorage.app",
            messagingSenderId: "777818785736",
            appId: "1:777818785736:web:880b878f4a510132dfe2fd",
            measurementId: "G-7KV0FSL1RG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // 取得環境 App ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // 將 Firebase 物件掛載到 window 以便 script.js 使用
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseModules = { doc, getDoc, setDoc };
        window.envAppId = appId; // 暴露 App ID 給 JS

        // [關鍵修正] 執行登入
        const initAuth = async () => {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try {
              await signInWithCustomToken(auth, __initial_auth_token);
            } catch (e) {
              console.warn("Custom token failed, falling back to anonymous");
              await signInAnonymously(auth);
            }
          } else {
            await signInAnonymously(auth);
          }
        };
        initAuth();

    </script>

    <script src="script.js"></script>
</body>
</html>